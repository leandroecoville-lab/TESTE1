name: factory

on:
  workflow_dispatch:
    inputs:
      module_name:
        description: "Nome do m√≥dulo a construir"
        required: true
        type: string
      trace_id:
        description: "ID de rastreamento"
        required: true
        type: string
      blueprint_run_id:
        description: "Run ID do workflow de pre-factory (para baixar artifacts)"
        required: true
        type: string
      callback_url:
        description: "URL para notificar quando terminar"
        required: false
        default: ""
        type: string
      skip_code_gen:
        description: "Pular gera√ß√£o de c√≥digo (apenas Pack0)"
        required: false
        default: "false"
        type: string

permissions:
  contents: read
  actions: read

env:
  PYTHONPATH: services/pack-factory
  MODULE: ${{ inputs.module_name }}
  TRACE: ${{ inputs.trace_id }}
  LAI_ACTOR_ID: github-actions

jobs:
  # ============================================================
  # STEP 1: Baixar Blueprint da Pr√©-F√°brica
  # ============================================================
  download-blueprint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Blueprint Artifacts
        uses: actions/download-artifact@v4
        with:
          name: blueprint-${{ inputs.trace_id }}
          path: _blueprint/
          run-id: ${{ inputs.blueprint_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Blueprint
        run: |
          echo "üìã Arquivos do Blueprint:"
          ls -la _blueprint/
          test -f _blueprint/idea_brief.json || (echo "‚ùå idea_brief.json ausente" && exit 1)
          test -f _blueprint/build_blueprint.md || (echo "‚ùå build_blueprint.md ausente" && exit 1)
          echo "‚úÖ Blueprint verificado"

      - uses: actions/upload-artifact@v4
        with:
          name: blueprint-verified
          path: _blueprint/

  # ============================================================
  # STEP 2: Pack0 ‚Äî Planejamento SRS
  # ============================================================
  pack0:
    needs: download-blueprint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r services/pack-factory/requirements.txt

      - name: Download Blueprint
        uses: actions/download-artifact@v4
        with:
          name: blueprint-verified
          path: _blueprint/

      - name: Generate Pack0
        run: |
          mkdir -p _out
          PYTHONPATH=services/pack-factory \
            python -m app.cli plan-pack0 \
              --module "$MODULE" \
              --out _out \
              --trace "${TRACE}-P0"
          echo "‚úÖ Pack0 gerado"
          ls -la _out/

      - name: Validate Pack0
        run: |
          PACK0_ZIP="$(ls _out/pack0-*.zip | head -1)"
          echo "üì¶ Pack0 zip: $PACK0_ZIP"

          PYTHONPATH=services/pack-factory \
            python -m app.cli validate-pack0 \
              --target "$PACK0_ZIP" \
              --out _out/validate.json \
              --trace "${TRACE}-V0"

          echo "üìä Resultado da valida√ß√£o:"
          cat _out/validate.json

          python -c "
          import json, sys
          v = json.load(open('_out/validate.json'))
          if not v.get('valid', False):
            print('‚ùå Pack0 falhou na valida√ß√£o')
            print(json.dumps(v.get('issues', []), indent=2, ensure_ascii=False))
            sys.exit(1)
          print('‚úÖ Pack0 validado com sucesso')
          "

      - uses: actions/upload-artifact@v4
        with:
          name: pack0-${{ inputs.module_name }}
          path: _out/

  # ============================================================
  # STEP 3: Pack1 ‚Äî C√≥digo Execut√°vel (Claude gera o c√≥digo)
  # ============================================================
  pack1:
    needs: pack0
    if: ${{ inputs.skip_code_gen != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r services/pack-factory/requirements.txt
          pip install anthropic

      - name: Download Pack0
        uses: actions/download-artifact@v4
        with:
          name: pack0-${{ inputs.module_name }}
          path: _out/

      - name: Download Blueprint
        uses: actions/download-artifact@v4
        with:
          name: blueprint-verified
          path: _blueprint/

      - name: Generate Pack1 (scaffold)
        run: |
          PYTHONPATH=services/pack-factory \
            python -m app.cli plan-pack1 \
              --module "$MODULE" \
              --out _out \
              --trace "${TRACE}-P1"
          echo "‚úÖ Pack1 scaffold gerado"
          ls -la _out/

      - name: Generate Code via Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PACK0_ZIP="$(ls _out/pack0-*.zip | head -1)"
          PACK1_DIR="$(ls -d _out/pack1-* 2>/dev/null | head -1)"

          echo "üì¶ Pack0 zip: $PACK0_ZIP"
          echo "üìÅ Pack1 dir: $PACK1_DIR"

          if [ -z "$PACK1_DIR" ]; then
            echo "‚ùå Pack1 dir n√£o encontrado em _out/"
            exit 1
          fi

          python scripts/factory_agent.py \
            --blueprint _blueprint/build_blueprint.md \
            --pack0 "$PACK0_ZIP" \
            --pack1-dir "$PACK1_DIR" \
            --module "$MODULE" \
            --trace "${TRACE}-CODE"

          echo "‚úÖ C√≥digo gerado via Claude"

      - name: Run Tests
        run: |
          PACK1_DIR="$(ls -d _out/pack1-* 2>/dev/null | head -1)"
          if [ -z "$PACK1_DIR" ]; then
            echo "‚ùå Pack1 dir n√£o encontrado"
            exit 1
          fi

          cd "$PACK1_DIR"
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "package.json" ]; then npm install; fi
          PYTHONPATH=. python -m pytest tests/ -q --tb=short 2>&1 || true

      - uses: actions/upload-artifact@v4
        with:
          name: pack1-${{ inputs.module_name }}
          path: _out/

  # ============================================================
  # STEP 4: PEC Chain ‚Äî Promover snapshot
  # ============================================================
  promote:
    needs: [pack0, pack1]
    if: ${{ always() && needs.pack0.result == 'success' && (needs.pack1.result == 'success' || needs.pack1.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r services/pack-factory/requirements.txt

      - name: Download Pack0
        uses: actions/download-artifact@v4
        with:
          name: pack0-${{ inputs.module_name }}
          path: _out/

      - name: Download Pack1 (se existir)
        if: ${{ needs.pack1.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: pack1-${{ inputs.module_name }}
          path: _out/

      - name: PEC Chain (run-report ‚Üí approve ‚Üí merge promoted)
        run: |
          PACK_ZIP="$(ls _out/pack1-*.zip 2>/dev/null | head -1 || true)"
          if [ -z "$PACK_ZIP" ]; then
            PACK_ZIP="$(ls _out/pack0-*.zip | head -1)"
          fi

          echo "üì¶ Target pack: $PACK_ZIP"

          mkdir -p _tmp

          # 1) Run Report
          PYTHONPATH=services/pack-factory \
            python -m app.cli run-report \
              --target "$PACK_ZIP" \
              --out _out/run_report.json \
              --actor "$LAI_ACTOR_ID" \
              --trace "${TRACE}-RR"

          # 2) Approve
          PYTHONPATH=services/pack-factory \
            python -m app.cli approve-pack \
              --target "$PACK_ZIP" \
              --run-report _out/run_report.json \
              --out _out/approval.json \
              --actor "$LAI_ACTOR_ID" \
              --trace "${TRACE}-AP"

          # 3) Wrap patches
          PYTHONPATH=services/pack-factory \
            python -m app.cli wrap-run-report \
              --in _out/run_report.json \
              --out _out/patch_rr.zip \
              --trace "${TRACE}-WR"

          PYTHONPATH=services/pack-factory \
            python -m app.cli wrap-approval \
              --in _out/approval.json \
              --out _out/patch_ap.zip \
              --trace "${TRACE}-WA"

          # 4) Merge Promoted
          PYTHONPATH=services/pack-factory \
            python -m app.cli merge \
              --mode promoted \
              --inputs "$PACK_ZIP" _out/patch_rr.zip _out/patch_ap.zip \
              --out _out/snapshot_promoted.zip \
              --tmp _tmp \
              --trace "${TRACE}-MRG"

          echo "‚úÖ Snapshot promoted gerado"
          ls -la _out/

      - uses: actions/upload-artifact@v4
        with:
          name: snapshot-promoted-${{ inputs.module_name }}
          path: _out/snapshot_promoted.zip

  # ============================================================
  # STEP 5: Export team-safe + leak check
  # ============================================================
  export:
    needs: promote
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r services/pack-factory/requirements.txt

      - name: Download Snapshot
        uses: actions/download-artifact@v4
        with:
          name: snapshot-promoted-${{ inputs.module_name }}
          path: _out/

      - name: Export Team Pack
        run: |
          PYTHONPATH=services/pack-factory \
            python -m app.cli export-team-pack \
              --in _out/snapshot_promoted.zip \
              --out "_out/team_pack_${MODULE}.zip" \
              --trace "${TRACE}-EXP"

      - name: Leak Check (gate de seguran√ßa)
        run: |
          PYTHONPATH=services/pack-factory \
            python -m app.cli leak-check \
              --target "_out/team_pack_${MODULE}.zip" \
              --out _out/leak_report.json \
              --trace "${TRACE}-LC"

          python -c "
          import json, sys
          r = json.load(open('_out/leak_report.json'))
          if r.get('leaks_found', 0) > 0:
            print('‚ùå VAZAMENTO DETECTADO!')
            print(json.dumps(r, indent=2, ensure_ascii=False))
            sys.exit(1)
          print('‚úÖ Nenhum vazamento. Pack seguro para entrega.')
          "

      - name: Upload Final Deliverable
        uses: actions/upload-artifact@v4
        with:
          name: ENTREGA-${{ inputs.module_name }}-${{ inputs.trace_id }}
          path: |
            _out/team_pack_${{ env.MODULE }}.zip
            _out/leak_report.json

  # ============================================================
  # STEP 6: Criar GitHub Release
  # ============================================================
  release:
    needs: export
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Deliverable
        uses: actions/download-artifact@v4
        with:
          name: ENTREGA-${{ inputs.module_name }}-${{ inputs.trace_id }}
          path: _release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v0.1.0-${{ inputs.module_name }}-${{ inputs.trace_id }}
          name: "üè≠ ${{ inputs.module_name }} ‚Äî Build ${{ inputs.trace_id }}"
          body: |
            ## Software gerado automaticamente pela F√°brica LAI

            **M√≥dulo:** ${{ inputs.module_name }}
            **Trace:** ${{ inputs.trace_id }}
            **Gerado em:** ${{ github.run_id }}

            ### Conte√∫do
            - `team_pack_${{ inputs.module_name }}.zip` ‚Äî C√≥digo-fonte + docs + testes
            - `leak_report.json` ‚Äî Relat√≥rio de seguran√ßa

            ### Como usar
            1. Baixe o ZIP
            2. Extraia
            3. Siga `runbooks/HOW_TO_RUN.md`
          files: _release/*

  # ============================================================
  # Callback final
  # ============================================================
  notify-done:
    needs: release
    if: ${{ inputs.callback_url != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install requests

      - name: Notify Callback
        env:
          CALLBACK_URL: ${{ inputs.callback_url }}
          CALLBACK_SECRET: ${{ secrets.CALLBACK_SECRET }}
          BUILD_ID: ${{ github.run_id }}
          TRACE_ID: ${{ inputs.trace_id }}
          MODULE: ${{ inputs.module_name }}
        run: |
          python scripts/notify_callback.py \
            --status "completed" \
            --phase "factory" \
            --message "Software pronto para download." \
            --download-url "https://github.com/${{ github.repository }}/releases/tag/v0.1.0-${MODULE}-${TRACE_ID}"
